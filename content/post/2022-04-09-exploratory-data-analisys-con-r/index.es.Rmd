---
title: Exploratory Data Analisys con R
author: F.VilBer
date: '2022-04-09'
slug: []
categories:
  - R
tags:
  - data minning
  - graficas
description: 'EDA con R, echar un vistazo a los datos'
thumbnail: '/post/2022-04-09-exploratory-data-analisys-con-r/images/EDA_P.png'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(error=FALSE,echo = TRUE, warning = FALSE, message = FALSE)
#![](images/EDA_P.png)
```

## Exploratory Data Analisys con R {#eda1}

Llamamos An치lisis Exploratorio de Datos (acr칩nimo **EDA** del ingl칠s) al proceso inicial de reconocimiento o, lo que sencillamente entendemos como **echar un vistazo** a los datos y as칤 empezar a comprender un poco lo que contienen y qu칠 se puede hacer con ellos.

He dividido el art칤culo en 3 partes, en la primera vemos *"lo b치sico"* e imprescindible que son las funciones de *RBase* para echar un vistazo a los datos tabulados. En la [segunda parte](#p2) hablamos de las librer칤as espec칤cifas para *EDA* que aportan gran valor al simplificar procesos, gr치ficas y en general facilitar el primer contacto con datos tabulados para su mejor comprensi칩n. En concreto veremos los paquetes `skimr`, `visdat` y el que m치s me gusta `inspecdf`.

En la [3췈 parte](#p3) os indico, sin entrar en mucho detalle, algunos paquetes que hacen *EDA* de forma automatizada generando completos informes con un click.

# Introducci칩n. Trabajar con tablas {#intro}

Una tabla es un conjunto estructurado de datos ordenados en filas (registros) y columnas (variables).

Antes de empezar a usar una tabla en nuestros an치lisis, lo primero que debemos comprobar es que se trata de **datos procesados**, es decir, que cumplen estas 5 reglas:

1.  cada variable debe estar en una sola columna
2.  cada observaci칩n debe estar en una fila diferente
3.  debe haber una tabla para cada tipo de variables
4.  cada variable o columna debe tener un nombre y este debe tener sentido.
5.  cada tabla debe estar en un fichero diferente.

Lo habitual, es que **NO LOS CUMPLA**, y tengamos que trabajar sobre los *datos brutos* hasta obtener una tabla de *datos procesados*.  En este post veremos, como ejemplo, las funciones para pasar de tabla larga a tabla ancha para cumplir estas reglas.

## Obtenci칩n de datos

Para ver un caso real de verdad y no la t칤pica tabla de ejemplo de una librer칤a os propongo buscar datos en alguna de estas webs:

-   [kaggle](https://www.kaggle.com/) es una web que ofrece *open data*
-   [10-datasets-kids](https://www.littlemissdata.com/blog/10-datasets-kids)
-   La EU ofrece datos y tablas en abierto "oficiales" <https://data.europa.eu/es>
-   Datos econ칩micos del[banco muncial](https://datacatalog.worldbank.org/search?q=spain&sort=last_updated_date%20desc)
-   [google researche](https://datasetsearch.research.google.com/)
-   [Gobierno de Espa침a](https://datos.gob.es/)

### Descarga de datos de trabajo

Para nuestro ejemplo vamos a usar datos de compra-venta de viviendas en Espa침a que he encontrado en la web de datos abiertos del Gobierno de Espa침a [aqu칤](https://datos.gob.es/es/catalogo/ea0010587-hipotecas-anuales-por-naturaleza-de-la-finca-provincias-duracion-en-anos-y-numero-e-importe-hpt-identificador-api-3240).

Podemos descargar el fichero directamente de la web con formato `csv` o copiar el enlace a R y bajarlo con c칩digo como explico en el bloque siguiente. Usamos la funci칩n `read.csv()` para leer el fichero descargado.

```{r eval=FALSE}
# descarga de datos directamente con R
library(RCurl)
viv<-getURL("https://www.ine.es/jaxiT3/files/t/es/csv_bdsc/3240.csv")
```

```{r echo=FALSE}
#ocultamos este code chunk para aparentar que lo lee de la web
#viv<-file.choose()  # caso de que lo hayamos descargado, lo buscamos en ficheros
#viv_df<-read.csv("3240.csv",header = T,sep = ";",strip.white = TRUE,stringsAsFactors = F, encoding="UTF-8")

#saveRDS(viv_df, file = "viviendas.rds")
# Restore the object
viv_df<-readRDS(file = "viv_df.rds")
```

```{r eval=FALSE}
# Lectura de la tabla csv a R
viv_df<-read.csv(viv,header = T,sep = ";",strip.white = TRUE,stringsAsFactors = F, encoding="UTF-8")
```

En realidad, te confieso que para leer esta tabla correctamente he tenido que descargar antes los datos y ver algunas cosas internas del fichero, como ver si tiene encabezado de las columnas (`header = T`), ver qu칠 separador de campos usa (`sep = ";"`). Tambi칠n he incluido el `encoding="UTF-8"` que hace que la lectura de tildes y *e침es* del espa침ol se lean bien y no se corrompa con extra침os s칤mbolos.

Como ves, obtener los datos requiere de un proceso de prueba y error 游눩 . Por eso me gusta empezar con casos reales y no con *data.frame* de prueba que traen los paquetes, que ya tienen todo masticadito y perfecto.

## Parte 1. Primer vistazo -EDA {#p1}

Ahora que tenemos la tabla bruta lo primero es echar un vistazo a los datos y para eso lo mejor es usar las funciones de *RBase* cl치sicas que son:

 * `str()`俱뫮잺 muestra un resumen de la estructura de la tabla
 * `head()` y `tail()` 俱뫮잺 muestra los primeros o 칰ltimos registros
 * `summary()`俱뫮잺 hace un resumen estadistico por variables
 * `glimpse()` de *dplyr* lo mismo que str, pero m치s compacto.
 *  `dim()` 俱뫮잺 da las dimensiones de la tabla
 *  `nrow()`,`ncol()` 俱뫮잺 el n칰mero de filas o de columnas que tiene.
 *  `table(df$col1)` 俱뫮잺  res칰menes agregados por columan  (cuenta casos
 *  `unique()`俱뫮잺 nos muestra los valores 칰nicos (sin repeticiones) de una variable
 * `aggregate()` 俱뫮잺 una funci칩n super util para resumir y agregar datos de manera simple.
 * `View(df)` te muestra la tabla con las celdas directamente en RSTUDIO.

Veamos alg칰n ejemplo:
```{r EDA_base}
# Primer vistazo a los datos con RBase
#str(viv_df)  # = que glimpse()
head(viv_df,3)
#tail(viv_df,3)
#summary(viv_df)
dplyr::glimpse(viv_df)
```

Con estas funciones ver치s que se trata de una tabla de 6 columnas y 47.700 filas. El primer problema es que los nombres de las columnas son muy largos, y esto no va bien para los futuros gr치ficos, as칤 que vamos a renombrar las variables. esto se hace de una manera simple pasando un vector con los nombres nuevos ordenados:

```{r}
# Nuevos nombres de las columnas
names(viv_df)<-c( "t_finca", "provincia", "a침os","importe","periodo","total")
```

A mi me gusta ver una muestra aleatoria de datos y uso este peque침o truco

```{r}
# Mostrar 6 registros aleatorios
viv_df[sample(1:nrow(viv_df),6),]
```


## De tabla larga a tabla ancha

En el resumen `summary()` de los datos he visto algo raro.... si os fijais, la columna "*importe*" tiene solo dos posibles valores `r unique(viv_df$importe)` y tiene pinta de que a cada valor de *importe* le corresponde un valor de la columna *total*. Esto no cumple los principios de [datos procesados](#intro). 

Han incluido dos variables en una misma columna. Es un t칤pico caso de *tabla larga*, que hay que pasar a *tabla ancha*. Cada uno de los dos valores 칰nicos de la columna "*importe*" est치n relacionados con la columna "*total*", as칤 que vamos a **desdoblar** esta columna en dos usando la librer칤a `tidyr`incluida en *tidyverse* con la funci칩n `pivot_wider()` en la que decimos la columna que contiene los nombres y la columna que tiene los datos y la desdobla as칤 creando 2 nuevas columnas.

```{r}
library(tidyverse)# tidyr
# vamos a coger los datos de nombre de la col importe y los valores de total
viv_ancha <- pivot_wider(viv_df, names_from = importe, values_from = total)
# cambiamos los nombres de las dos columnas nuevas
names(viv_ancha)[5]<-"num_hipo"
names(viv_ancha)[6]<-"import_hipo"

# Vemos algunos registros aleatorios de esta nueva tabla
viv_ancha[sample(1:nrow(viv_ancha),6),]
```

El proceso inverso se har칤a con la funci칩n `pivot_longer()`.

## Convertir a n칰meros los factores

Hay varias columnas num칠ricas que como vemos en el resumen las toma como factores o texto seg칰n hayamos usado `stringsAsFactors = T` en la lectura de los datos. El problema es que las variables num칠ricas no las ha interpretado como tal, quiz치s por el punto de los miles,as칤 que vamos a quitarlo y transformar a num칠ricas.

Para hacer esto usaremos la funci칩n `gsub(patron_a_cambiar,texto_remplazo,vector)`.

```{r}
# convertimos las columnas de texto a num칠ricas y antes eliminamos el punto de miles
viv_ancha$import_hipo<-as.numeric(gsub("[.]", "",viv_ancha$import_hipo))
viv_ancha$num_hipo<-as.numeric(gsub("[.]", "",viv_ancha$num_hipo))

# Vemos algunos registros aleatorios
viv_ancha[sample(1:nrow(viv_ancha),6),]
```

## Valores inv치lidos
Ahora nos surge otro problema, y es que vemos que los datos tiene muchos valores inv치lidos o *NA*. Los valores inv치lidos hay que contarlos siempre, para estimar la calidad de la muestra y quitarlos o imputarlos (rellenar con formulaci칩n en caso de que lo creamos necesario). En nuestro ejemplo fundamentalmente los quitaremos para las gr치ficas, pero hay que ver cuantos hay con las funciones siguientes.

```{r}
sum(is.na(viv_ancha)) # cuenta los NAs totales
sum(complete.cases(viv_ancha)) # cuenta los casos completos de la tabla
nrow(na.omit(viv_ancha))# omite los casos inv치lidos y cuenta los que hay
#guardamos una nueva tabla solo con casos completos
viv_ancha2<-na.omit(viv_ancha)
```
## aggregate
Solo nos queda a침adir al resumen de funciones un ejemplo de `aggregate` que para mi es una de las funciones m치s 칰tiles en esta fase de ver los datos, pues nos permite hacer subtotales f치cilmente.

```{r}
# calculamos el num de hipotecas por a침o, descontando el total nacional
aggregate(num_hipo ~ periodo,viv_ancha[!viv_ancha$provincia == "Total Nacional",],sum)
```


# Parte 2. Librer칤as para EDA b치sico {#p2}

Hemos visto las funciones b치sicas de R para echar un vistazo inicial a los datos, a estas funciones les podemos a침adir todas las funciones gr치ficas que queramos, con las que poder pintar las variables y sus relaciones (como `hist()`, `plot()`, o librer칤as como `ggplot()`), pero en lugar de hacerlo as칤, dedicaremos esta 2췈 parte a ver paquetes *espec칤ficos para EDA* y que directamente nos dan unas buenas funciones gr치ficas y tablas resumen en pocas l칤neas de c칩digo.

## skimr
`skimr` es una librer칤a que da un primer vistazo bueno y r치pido al generar una *mini-gr치fica* de histograma, as칤 como un resumen completo por variables, pensado especialmente para verlo en pantalla y no para generar informes finales. 

```{r}
library(skimr)
skim(viv_ancha) # funci칩n principal
```
Se puede extraer cada una de las partes de este resumen:

```{r}
#resumen de valores num칠ricos
viv_ancha %>%
  skim() %>%
  yank("numeric")
```

## visdat

Otro paquete para ver los datos es `visdat`. Esta librer칤a tiene una gr치fica que me gusta bastante como resumen, con la funci칩n `vis_dat()`, que muestra la distribuci칩n por tipo de dato, e incluso los `NA`:

```{r}
library(visdat)

#vis_miss(viv_ancha)
vis_dat(viv_ancha)
```

## inspectdf

Como tercera opci칩n y la que m치s me gusta est치 la librer칤a *inspectdf* que proporciona gr치ficos resumen de gran calidad y concreci칩n. La salida gr치fica para las variables factores est치 muy conseguida y en general son intuitivos y de f치cil comprensi칩n.

Podeis encontrar m치s informaci칩n en este fant치stico [post de littlemissdata](https://www.littlemissdata.com/blog/inspectdf). Veamos varias gr치ficas obtenidas con esta librer칤a aplicada directamente a algunas de las tablas que hemos procesado en el ejemplo.

```{r}
#devtools::install_github("alastairrushworth/inspectdf")
library(inspectdf)

# Graficas EDA con inspectdf sobre los datos de ejemplo
inspect_types(viv_ancha) %>% show_plot() # tipos de datos
inspect_mem(viv_ancha) %>% show_plot() # basic sizing information
inspect_na(viv_ancha) %>% show_plot() # no va
inspect_cat(viv_ancha) %>% show_plot() # ver categ칩ricos
```
La gr치fica que proporciona dividiendo por categor칤as es de lo mejor que he visto, muy visual y que permite un primer vistazo potente.

Las que resumen los datos num칠ricos tambi칠n, pero en la tabla de muestra no se aprecia, as칤 que vamos a pintar m치s ejemplos, pero usando la tabla `airquality` con datos de calidad del aire:

```{r}
inspect_num(airquality) %>% show_plot() # explorar los numeric
inspect_types(airquality) %>% show_plot()
inspect_num(airquality) %>% show_plot()
```

Una cosa interesante de *inspectdf* es que se puede comprar dos tablas similares, que tengan las mismas columnas y nos da gr치ficas muy interesantes. Por ejemplo, las tablas *viv_ancha* y *viv_ancha2* se diferencian en que quitamos los NA o inv치lidos, veamos como lo representa:

```{r}
# comparativa de dos tablas procesadas una sin NA
inspect_na(viv_ancha,viv_ancha2) %>% show_plot() # no va
inspect_cat(viv_ancha, viv_ancha2) %>% show_plot() # ver 
```

# Parte 3. EDA autom치tico {#p3}

En esta tercera parte veremos paquetes que generan un informe completo y autom치tico a partir de la tabla de datos, son la soluci칩n para tontos: *pulse el bot칩n rojo y listo* 游땦.

En realidad estas librer칤as son excelentes cuando tenemos unos datos de partida complejos con muchas columnas y registros, pues dan una salida resumen r치pida y estructurada con excelentes gr치ficas, perfectas para copiar en informes.

## DataExplorer

`DataExplorer` es la librer칤a m치s conocida para an치lisis exploratorio *EDA*. Es muy simple y ofrece una salida -tipo informe- que aporta much칤sima informaci칩n. Su uso es tan f치cil que asusta, solo cargamos la librer칤a y llamamos la funci칩n `create_report` sobre la tabla que queremos ver.

```{r, eval=FALSE, echo=TRUE}
library(DataExplorer)
# llamada a la funci칩n informe autom치tico
create_report(viv_ancha)
```

Lo que hace la funci칩n `create_report` es generar un documento en formato *html* llamado *report.html* que se guarda en el directorio de trabajo (si no sabes cual es usa `getwd()`). Si abrimos ese fichero veremos un completo an치lisis cuyo indice es el siguiente:

![indice del informe DataExplorrer](images/dataexplorer_index.png)

Cada una de las gr치ficas y tablas del informe se puede hacer de forma independiente con funciones espec칤ficas de la librer칤a, por ejemplo:

```{r}
library(DataExplorer)
introduce(viv_ancha) #tabla resumen de columnas y tipos
# gr치fico intro
plot_intro(viv_ancha)
 #plot_missing(viv_ancha)
 #plot_bar(viv_ancha) # grafica de factores
plot_bar(viv_ancha,by = "t_finca") # grafica de un
 #plot_correlation(viv_ancha, maxcat = 5L) # correlacion de 5 primeras categor칤as
 #plot_histogram(viv_ancha)
```

Puedes encontrar m치s informaci칩n de este paquete en:<https://cran.r-project.org/web/packages/DataExplorer/vignettes/dataexplorer-intro.html>

## SmartEDA

Otra librer칤a parecida es `SmartEDA`, con un funcionamiento similar a `DataExplorer`, aunque tiene una diferencias muy agradecida y es que escribe el c칩digo de cada gr치fica o tabla en el informe. La funci칩n principal es `ExpReport()`

```{r eval=FALSE, echo=TRUE}
library(SmartEDA)
data<- airquality
# funcioin que genera un informa completo
ExpReport(data,op_file='informeEDA.html')

# si queremos alguna gr치fica o tabla por separado
ExpData(data=data,type=1)
ExpData(data=data,type=2)

ExpNumStat(data,by="A",gp=NULL,Qnt=seq(0,1,0.1),MesofShape=2,Outlier=TRUE,round=2)
# una tabla resumen con multitud de estadisticos de las variables numericas
ExpNumStat(viv_ancha,by="A",gp=NULL,round=2)
```
Esta es una imagen del informe de salida:

![](images/SmartEDA.png){width=400px}

## dlookr
Otra librer칤a, para mi la mejor, para EDA es [dlookr](https://choonghyunryu.github.io/dlookr/). Con una simple funci칩n nos genera un complet칤simo informe de los datos origen en formato p치gina web.

Adem치s tiene mil opciones de estad칤sticos, gr치ficas o transformaciones, incluso imputaci칩n de valores NA (relleno de datos).

Vamos a poner algunos simples ejemplos. Para generar el informe completo se usa la funci칩n `diagnose_web_report()` o `eda_web_report()` seg칰n el inter칠s ultimo que buscamos.

```{r eval=FALSE, echo=TRUE}
library(dlookr)
library(dplyr)
#library(nycflights13)# Para los datos de ejemplo 
eda_web_report(viv_ancha2)
diagnose_web_report(viv_ancha) # 
```
Una imagen del informe de salida es as칤:

![dlookr imagen de informe salida](images/dlookr.png){width=400px}

La librer칤a tiene mil opciones de an치lisis y entre las funciones disponibles, aqu칤 van algunos ejemplos:

```{r}
library(dlookr)
library(dplyr)

diagnose(viv_ancha)
describe(viv_ancha)
normality(viv_ancha)
plot_normality(viv_ancha)
plot_correlate(viv_ancha)
```

Recomendamos leer su web y la descripci칩n de las funciones al detalle para sacar partido a esta maravilla.
